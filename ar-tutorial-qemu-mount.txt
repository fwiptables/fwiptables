#!/bin/bash
#### tutorial para montar una imagen de qemu

#### #### mount:
#### secuencia de montaje de nbd
if [ "$1" = "mount" ] && [  -f "$2" ]; then

#### carga el modulo del kernel
modprobe nbd max_part=8

#### conecta un disco
qemu-nbd --connect=/dev/nbd0 $2

#### lista las particiones
fdisk /dev/nbd0 -l

#### monta la imagen de qemu
mkdir -p $HOME/mnt/nbd0p1 &> /dev/null
MKDIR -P $HOME/mnt/nbd0p2 &> /dev/null
umount $HOME/mnt/nbd0p* &> /dev/null
mount /dev/nbd0p1 $HOME/mnt/nbd0p1/ &> /dev/null
mount /dev/nbd0p2 $HOME/mnt/nbd0p2/ &> /dev/null
echo "OK. qemu image mounted in $HOME/mnt/nbd0p1 and nbd0p2"
exit; fi

#### #### umount:
#### desmonta y desconecta la imagen de qemu
if [ "$1" = "umount" ]; then
umount $HOME/mnt/nbd0p* &> /dev/null
qemu-nbd --disconnect /dev/nbd0 &> /dev/null
echo "Ok. Umounted"
exit; fi

#### #### usage:
echo "usage for $0"
echo "mount with:  launch $0 mount imagen-qemu"
echo "umount with: launch $0 umount"


