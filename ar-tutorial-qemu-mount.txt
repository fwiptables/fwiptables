#!/bin/bash
#### tutorial para montar una imagen de qemu

#### #### mount:
#### secuencia de montaje de nbd
if [ "$1" = "mount" ] && [  -f "$2" ]; then

#### carga el modulo del kernel
modprobe nbd max_part=4

#### conecta un disco
qemu-nbd --connect=/dev/nbd0 "$2"

#### lista las particiones
fdisk /dev/nbd0 -l

#### monta la imagen de qemu
for mparts in 1 2 3 4 ; do
mkdir -p $HOME/mnt/nbd0p"$mparts" &> /dev/null
umount $HOME/mnt/nbd0p"$mparts" &> /dev/null
mount -t auto /dev/nbd0p1 $HOME/mnt/nbd0p"$mparts"
echo "OK. qemu image mounted in $HOME/mnt/nbd0p""$mparts"
done; exit; fi

#### #### umount:
#### desmonta y desconecta la imagen de qemu
if [ "$1" = "umount" ]; then
umount $HOME/mnt/nbd0p* &> /dev/null
qemu-nbd --disconnect /dev/nbd0 &> /dev/null
echo "Ok. Umounted"
exit; fi

#### #### usage:
echo "usage for $0"
echo "mount with:  launch $0 mount imagen-qemu"
echo "umount with: launch $0 umount"


